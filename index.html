<!DOCTYPE html>
<html>

<head>
    <title>Popular Repos</title>
    <script crossorigin src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script src='https://unpkg.com/babel-standalone@6/babel.min.js'></script>
</head>

<body>
    <div id='app'></div>
    <script>
        window.API = {
            fetchPopularRepos(language) {
                // "language" can be "javascript", "ruby", "python", or "all"
                const encodedURI = encodeURI(`https://api.github.com/search/repositories?q=stars:>1+language:${language}&sort=stars&order=desc&type=Repositories`)
                return fetch(encodedURI)
                    .then((data) => data.json())
                    .then((repos) => repos.items)
                    .catch((error) => {
                        console.warn(error)
                        return null
                    });
            }
        }
    </script>

    <script type='text/babel'>

    class Loading extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
          text: 'Loading'
        };
      }
      componentDidMount() {
        const stopper = this.state.text + '...';
        this.interval = window.setInterval(() => {
          this.state.text === stopper
            ? this.setState(() => ({ text: 'Loading' }))
            : this.setState((prevState) => ({ text: prevState.text + '.' }))
        }, 300)
      }
      componentWillUnmount() {
        window.clearInterval(this.interval);
      }
      render() {
        return (
          <p>
            {this.state.text}
          </p>
        )
      }
    }

    function Nav (props) {
            return (
                <ul>
                {
                    props.list.map((list)=>(
                        <li key={list} onClick={()=>props.onUpdateNav(list)} >
                        {list}
                        </li>
                    ))
                }
                </ul>
            )
        
    }

    function Repos(props) {
            return (
                props.repos.map((repo)=>{
                  return (
                    <ul key={repo.full_name} >
                        <li>{repo.full_name}</li>
                    </ul>
                  )
                })
            )
    }

    class App extends React.Component {

        constructor(props) {

            super(props);

             this.state = {
                navList: ['all', 'python', 'ruby', 'javascript'],
                repos: [],
                currentNav: 'all',
                loading: true
            };

            this.updateNav = this.updateNav.bind(this);
            this.fetchRepos = this.fetchRepos.bind(this);


        }

        componentDidMount() {
           this.fetchRepos(this.state.currentNav);
        }

        componentDidUpdate(prevProps, prevState) {
            if (prevState.currentNav !== this.state.currentNav) {                
                this.fetchRepos(this.state.currentNav);
            }

        }

        fetchRepos(nav) {
            this.setState({
                loading: true
            })

             window.API.fetchPopularRepos(nav)
                .then((repos)=>{
                    console.log('repos: ', repos);
                    this.setState((currentState)=>{
                        return {
                            repos,
                            loading: false
                        }
                    })
                })
        }

        updateNav(nav) {
            this.setState({
                    currentNav: nav
            })
        }

      render() {
        return (
          <div>
            <Nav 
                list={this.state.navList}
                onUpdateNav={this.updateNav}
             />
            <h1> {this.state.currentNav} </h1>
          {
              this.state.loading === true ? <Loading /> :   <Repos repos={this.state.repos} />
          }
          </div>
        )
      }
    }
    ReactDOM.render(
      <App />,
      document.getElementById('app')
    )
  </script>
</body>

</html>